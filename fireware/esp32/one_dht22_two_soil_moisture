/**
 * ESP32 Sensor Server
 * --------------------
 * ➤ 2 Soil Moisture Sensors (Analog)
 * ➤ 1 DHT22 Temperature + Humidity Sensor
 * ➤ REST API endpoint: /sensor
 * ➤ No Relay
 * ➤ Non-blocking periodic sensor reading
 * Author: VAJRAMANASA PALGUNA H V
 */

#include <WiFi.h>
#include <WebServer.h>
#include <DHT.h>

// ------------------- PIN SETUP -------------------
#define DHT_PIN 4
#define DHTTYPE DHT22

#define SOIL1_PIN 34
#define SOIL2_PIN 33

DHT dht(DHT_PIN, DHTTYPE);
WebServer server(80);

// ------------------- WIFI -------------------
const char* ssid = "your wifi name";
const char* password = "pass";

// ------------------- SENSOR VARIABLES -------------------
float lastTemp = 0, lastHum = 0;
int s1, s2;

// ------------------- TIMING -------------------
unsigned long lastSensorRead = 0;
const unsigned long SENSOR_INTERVAL = 30000;   // 30 sec sensor read

// ------------------- FUNCTIONS -------------------
int moisturePercent(int raw) {
  return map(raw, 4095, 0, 0, 100);
}

// ------------------- SENSOR READ -------------------
void readSensors() {
  lastTemp = dht.readTemperature();
  lastHum  = dht.readHumidity();

  if (isnan(lastTemp) || isnan(lastHum)) {
    lastTemp = lastHum = 0;
  }

  s1 = moisturePercent(analogRead(SOIL1_PIN));
  s2 = moisturePercent(analogRead(SOIL2_PIN));

  // Full ESP URL
  String espURL = "http://" + WiFi.localIP().toString() + "/sensor";

  Serial.println("===== SENSOR DATA =====");
  Serial.printf("ESP32_URL → %s\n", espURL.c_str());
  Serial.printf("Temperature: %.2f°C\n", lastTemp);
  Serial.printf("Humidity: %.2f%%\n", lastHum);
  Serial.printf("Soil1: %d%%\n", s1);
  Serial.printf("Soil2: %d%%\n", s2);
  Serial.println("=======================\n");
}

// ------------------- API -------------------
void handleSensorAPI() {
  server.sendHeader("Access-Control-Allow-Origin", "*");

  String json = "{";
  json += "\"temperature\":" + String(lastTemp) + ",";
  json += "\"humidity\":" + String(lastHum) + ",";
  json += "\"soil1\":" + String(s1) + ",";
  json += "\"soil2\":" + String(s2);
  json += "}";

  server.send(200, "application/json", json);
}

// ------------------- SETUP -------------------
void setup() {
  Serial.begin(115200);
  delay(500);

  dht.begin();
  analogReadResolution(12);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println("\nConnected!");
  Serial.print("ESP32 IP: ");
  Serial.println(WiFi.localIP());

  server.on("/sensor", handleSensorAPI);
  server.begin();
}

// ------------------- LOOP -------------------
void loop() {
  server.handleClient();

  unsigned long now = millis();

  if (now - lastSensorRead >= SENSOR_INTERVAL) {
    lastSensorRead = now;
    readSensors();
  }
}
