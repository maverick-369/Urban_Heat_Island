/**
 * ESP32 Sensor Server
 * --------------------
 * ➤ 4 Soil Moisture Sensors (Analog)
 * ➤ 1 DHT22 Temperature + Humidity Sensor
 * ➤ With replay
 * ➤ REST API endpoint: /sensor
 * ➤ Non-blocking periodic sensor reading
 * Author: VAJRAMANASA PALGUNA H V
 **/

#include <WiFi.h>
#include <WebServer.h>
#include <DHT.h>

// ------------------- PIN SETUP -------------------
#define DHT1_PIN 4
#define DHT2_PIN 14
#define DHTTYPE DHT22

// 8 Soil moisture sensors
#define SOIL1_PIN 32
#define SOIL2_PIN 33
#define SOIL3_PIN 34
#define SOIL4_PIN 35
#define SOIL5_PIN 36
#define SOIL6_PIN 39
#define SOIL7_PIN 25
#define SOIL8_PIN 26

// Relay
#define RELAY_PIN 27
#define RELAY_ACTIVE_LOW 1

// ------------------- OBJECTS -------------------
DHT dht1(DHT1_PIN, DHTTYPE);
DHT dht2(DHT2_PIN, DHTTYPE);
WebServer server(80);

// ------------------- WIFI -------------------
const char* ssid = "your wifi name";
const char* password = "pass";

// ------------------- SENSOR VARIABLES -------------------
float temp1, hum1;
float temp2, hum2;

int soil[8];
int avg1 = 0;  // Soil 1–4
int avg2 = 0;  // Soil 5–8
int internalAvg = 0; // Used for relay only (not uploaded)

// ------------------- TIMING -------------------
unsigned long lastSensorRead = 0;
const unsigned long SENSOR_INTERVAL = 5000;

// Relay auto control timing
unsigned long relayLastToggle = 0;
bool relayState = false;

const unsigned long RELAY_ON_TIME  = 180000;   // 3 minutes
const unsigned long RELAY_OFF_TIME = 120000;   // 2 minutes

bool autoModeEnabled = false;

// ------------------- HELPERS -------------------
int moisturePercent(int raw) {
  return map(raw, 4095, 0, 0, 100);
}

// ------------------- SENSOR READ -------------------
void readSensors() {
  temp1 = dht1.readTemperature();
  hum1  = dht1.readHumidity();

  temp2 = dht2.readTemperature();
  hum2  = dht2.readHumidity();

  if (isnan(temp1) || isnan(hum1)) { temp1 = hum1 = 0; }
  if (isnan(temp2) || isnan(hum2)) { temp2 = hum2 = 0; }

  // Read all 8 soil sensors
  soil[0] = moisturePercent(analogRead(SOIL1_PIN));
  soil[1] = moisturePercent(analogRead(SOIL2_PIN));
  soil[2] = moisturePercent(analogRead(SOIL3_PIN));
  soil[3] = moisturePercent(analogRead(SOIL4_PIN));
  soil[4] = moisturePercent(analogRead(SOIL5_PIN));
  soil[5] = moisturePercent(analogRead(SOIL6_PIN));
  soil[6] = moisturePercent(analogRead(SOIL7_PIN));
  soil[7] = moisturePercent(analogRead(SOIL8_PIN));

  // Group 1 Average (Soil 1–4)
  avg1 = (soil[0] + soil[1] + soil[2] + soil[3]) / 4;

  // Group 2 Average (Soil 5–8)
  avg2 = (soil[4] + soil[5] + soil[6] + soil[7]) / 4;

  // INTERNAL average for relay logic
  internalAvg = (avg1 + avg2) / 2;

  String espURL = "http://" + WiFi.localIP().toString() + "/sensor";

  Serial.println("===== SENSOR DATA =====");
  Serial.println("ESP32 URL → " + espURL);

  Serial.printf("DHT1 Temp: %.2f°C, Humidity: %.2f%%\n", temp1, hum1);
  Serial.printf("DHT2 Temp: %.2f°C, Humidity: %.2f%%\n", temp2, hum2);

  for (int i = 0; i < 8; i++) {
    Serial.printf("Soil %d: %d%%\n", i + 1, soil[i]);
  }

  Serial.printf("Avg1 (Soil1–4): %d%%\n", avg1);
  Serial.printf("Avg2 (Soil5–8): %d%%\n", avg2);
  Serial.printf("Internal Avg Used for Relay: %d%%\n", internalAvg);

  Serial.printf("Relay State: %d\n", relayState);
  Serial.println("=======================\n");

  // Auto irrigation based on INTERNAL AVERAGE
  autoModeEnabled = (internalAvg < 50);
}

// ------------------- RELAY AUTO LOGIC -------------------
void handleRelayAuto() {
  unsigned long now = millis();

  if (!autoModeEnabled) {
    digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? HIGH : LOW);
    relayState = false;
    return;
  }

  if (!relayState) {
    if (now - relayLastToggle >= RELAY_OFF_TIME) {
      digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? LOW : HIGH);
      relayState = true;
      relayLastToggle = now;
      Serial.println("Relay TURNED ON (Auto Cycle)");
    }
  } else {
    if (now - relayLastToggle >= RELAY_ON_TIME) {
      digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? HIGH : LOW);
      relayState = false;
      relayLastToggle = now;
      Serial.println("Relay TURNED OFF (Auto Cycle)");
    }
  }
}

// ------------------- API -------------------
void handleSensorAPI() {
  server.sendHeader("Access-Control-Allow-Origin", "*");

  String json = "{";

  json += "\"temp1\":" + String(temp1) + ",";
  json += "\"hum1\":" + String(hum1) + ",";
  json += "\"temp2\":" + String(temp2) + ",";
  json += "\"hum2\":" + String(hum2) + ",";

  for (int i = 0; i < 8; i++) {
    json += "\"soil" + String(i+1) + "\":" + String(soil[i]) + ",";
  }

  // Only TWO averages are uploaded
  json += "\"avg1\":" + String(avg1) + ",";
  json += "\"avg2\":" + String(avg2) + ",";

  json += "\"relay_state\":" + String(relayState) + ",";
  json += "\"auto_mode\":" + String(autoModeEnabled);

  json += "}";

  server.send(200, "application/json", json);
}

// ------------------- SETUP -------------------
void setup() {
  Serial.begin(115200);
  delay(500);

  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? HIGH : LOW);

  dht1.begin();
  dht2.begin();
  analogReadResolution(12);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println("\nConnected!");
  Serial.print("ESP32 IP: ");
  Serial.println(WiFi.localIP());

  server.on("/sensor", handleSensorAPI);
  server.begin();
}

// ------------------- LOOP -------------------
void loop() {
  server.handleClient();

  unsigned long now = millis();

  if (now - lastSensorRead >= SENSOR_INTERVAL) {
    lastSensorRead = now;
    readSensors();
  }

  handleRelayAuto();
}
