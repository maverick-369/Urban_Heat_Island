/**
 * ESP32 Sensor Server
 * --------------------
 * ➤ 4 Soil Moisture Sensors (Analog)
 * ➤ 1 DHT22 Temperature + Humidity Sensor
 * ➤ REST API endpoint: /sensor
 * ➤ Non-blocking periodic sensor reading
 * Author: VAJRAMANASA PALGUNA H V
 */

#include <WiFi.h>
#include <WebServer.h>
#include <DHT.h>

// ------------------- PIN SETUP -------------------
#define DHT_PIN 4
#define DHTTYPE DHT22

#define SOIL1_PIN 32
#define SOIL2_PIN 33
#define SOIL3_PIN 34
#define SOIL4_PIN 35

DHT dht(DHT_PIN, DHTTYPE);
WebServer server(80);

// ------------------- WIFI -------------------
const char* ssid = "YOUR_WIFI_NAME";
const char* password = "YOUR_PASSWORD";

// ------------------- SENSOR VARIABLES -------------------
float lastTemp = 0, lastHum = 0;
int soil1 = 0, soil2 = 0, soil3 = 0, soil4 = 0;

// ------------------- TIMING -------------------
unsigned long lastSensorRead = 0;
const unsigned long SENSOR_INTERVAL = 5000; // 5 seconds

// ------------------- HELPER: Soil Moisture in % -------------------
int moisturePercent(int raw)
{
    return map(raw, 4095, 0, 0, 100);
}

// ------------------- SENSOR READ FUNCTION -------------------
void readSensors()
{
    lastTemp = dht.readTemperature();
    lastHum = dht.readHumidity();

    if (isnan(lastTemp) || isnan(lastHum)) {
        Serial.println("⚠ DHT read failed!");
        lastTemp = 0;
        lastHum = 0;
    }

    soil1 = moisturePercent(analogRead(SOIL1_PIN));
    soil2 = moisturePercent(analogRead(SOIL2_PIN));
    soil3 = moisturePercent(analogRead(SOIL3_PIN));
    soil4 = moisturePercent(analogRead(SOIL4_PIN));

    Serial.println("\n===== SENSOR DATA =====");
    Serial.printf("ESP32 URL → http://%s/sensor\n", WiFi.localIP().toString().c_str());
    Serial.printf("Temperature: %.2f°C\n", lastTemp);
    Serial.printf("Humidity: %.2f%%\n", lastHum);
    Serial.printf("Soil1: %d%%\n", soil1);
    Serial.printf("Soil2: %d%%\n", soil2);
    Serial.printf("Soil3: %d%%\n", soil3);
    Serial.printf("Soil4: %d%%\n", soil4);
    Serial.println("=======================\n");
}

// ------------------- /sensor API -------------------
void handleSensorAPI()
{
    server.sendHeader("Access-Control-Allow-Origin", "*");

    String json = "{";
    json += "\"temperature\":" + String(lastTemp) + ",";
    json += "\"humidity\":" + String(lastHum) + ",";
    json += "\"soil1\":" + String(soil1) + ",";
    json += "\"soil2\":" + String(soil2) + ",";
    json += "\"soil3\":" + String(soil3) + ",";
    json += "\"soil4\":" + String(soil4);
    json += "}";

    server.send(200, "application/json", json);
}

// ------------------- SETUP -------------------
void setup()
{
    Serial.begin(115200);
    delay(200);

    dht.begin();
    analogReadResolution(12);

    Serial.println("Connecting to WiFi...");
    WiFi.begin(ssid, password);

    while (WiFi.status() != WL_CONNECTED) {
        Serial.print(".");
        delay(300);
    }

    Serial.println("\nConnected!");
    Serial.print("ESP32 IP: ");
    Serial.println(WiFi.localIP());

    server.on("/sensor", handleSensorAPI);
    server.begin();

    Serial.println("Web server running...");
}

// ------------------- LOOP -------------------
void loop()
{
    server.handleClient();

    unsigned long now = millis();

    if (now - lastSensorRead >= SENSOR_INTERVAL) {
        lastSensorRead = now;
        readSensors();
    }
}
