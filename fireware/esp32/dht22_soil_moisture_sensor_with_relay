/**
 * ESP32 Sensor Server
 * --------------------
 * ➤ 4 Soil Moisture Sensors (Analog)
 * ➤ 1 DHT22 Temperature + Humidity Sensor
 * ➤ With replay
 * ➤ REST API endpoint: /sensor
 * ➤ Non-blocking periodic sensor reading
 * Author: VAJRAMANASA PALGUNA H V
 */

#include <WiFi.h>
#include <WebServer.h>
#include <DHT.h>

// ------------------- PIN SETUP -------------------
#define DHT_PIN 4
#define DHTTYPE DHT22

#define SOIL1_PIN 32
#define SOIL2_PIN 33
#define SOIL3_PIN 34
#define SOIL4_PIN 35

#define RELAY_PIN 25
#define RELAY_ACTIVE_LOW 0   // Set 0 if your relay is ACTIVE HIGH

DHT dht(DHT_PIN, DHTTYPE);
WebServer server(80);

// ------------------- WIFI -------------------
const char* ssid = "your wifi name";
const char* password = "pass";

// ------------------- SENSOR VARIABLES -------------------
float lastTemp = 0, lastHum = 0;
int s1, s2, s3, s4;
int avgMoisture = 0;

// ------------------- TIMING -------------------
unsigned long lastSensorRead = 0;
const unsigned long SENSOR_INTERVAL = 30000;

// Relay timing (auto cycle)
unsigned long relayLastToggle = 0;
bool relayState = false;

const unsigned long RELAY_ON_TIME  = 180000;  // 3 minutes
const unsigned long RELAY_OFF_TIME = 120000;  // 2 minutes

bool autoModeEnabled = false;

// ------------------- HELPERS -------------------
int moisturePercent(int raw) {
  return map(raw, 4095, 0, 0, 100);
}

// ------------------- SENSOR READ -------------------
void readSensors() {
  lastTemp = dht.readTemperature();
  lastHum  = dht.readHumidity();

  if (isnan(lastTemp) || isnan(lastHum)) {
    lastTemp = lastHum = 0;
  }

  s1 = moisturePercent(analogRead(SOIL1_PIN));
  s2 = moisturePercent(analogRead(SOIL2_PIN));
  s3 = moisturePercent(analogRead(SOIL3_PIN));
  s4 = moisturePercent(analogRead(SOIL4_PIN));

  avgMoisture = (s1 + s2 + s3 + s4) / 4;

  String espURL = "http://" + WiFi.localIP().toString() + "/sensor";

  Serial.println("===== SENSOR DATA =====");
  Serial.println("ESP32 URL → " + espURL);
  Serial.printf("Temperature: %.2f°C\n", lastTemp);
  Serial.printf("Humidity: %.2f%%\n", lastHum);
  Serial.printf("Soil1: %d%%\n", s1);
  Serial.printf("Soil2: %d%%\n", s2);
  Serial.printf("Soil3: %d%%\n", s3);
  Serial.printf("Soil4: %d%%\n", s4);
  Serial.printf("Average Moisture: %d%%\n", avgMoisture);
  Serial.printf("Relay State: %d\n", relayState);
  Serial.println("=======================\n");

  // Enable auto mode if soil moisture is too low
  autoModeEnabled = (avgMoisture < 50);
}

// ------------------- RELAY AUTO LOGIC -------------------
void handleRelayAuto() {
  unsigned long now = millis();

  if (!autoModeEnabled) {
    // No auto mode → always turn relay OFF
    digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? HIGH : LOW);
    relayState = false;
    return;
  }

  // Auto mode ON
  if (!relayState) {
    // Relay is OFF → wait OFF duration → turn ON
    if (now - relayLastToggle >= RELAY_OFF_TIME) {
      digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? LOW : HIGH);
      relayState = true;
      relayLastToggle = now;
      Serial.println("Relay TURNED ON (Auto Cycle)");
    }
  } else {
    // Relay is ON → wait ON duration → turn OFF
    if (now - relayLastToggle >= RELAY_ON_TIME) {
      digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? HIGH : LOW);
      relayState = false;
      relayLastToggle = now;
      Serial.println("Relay TURNED OFF (Auto Cycle)");
    }
  }
}

// ------------------- API -------------------
void handleSensorAPI() {
  server.sendHeader("Access-Control-Allow-Origin", "*");

  String json = "{";
  json += "\"temperature\":" + String(lastTemp) + ",";
  json += "\"humidity\":" + String(lastHum) + ",";
  json += "\"soil1\":" + String(s1) + ",";
  json += "\"soil2\":" + String(s2) + ",";
  json += "\"soil3\":" + String(s3) + ",";
  json += "\"soil4\":" + String(s4) + ",";
  json += "\"average_moisture\":" + String(avgMoisture) + ",";
  json += "\"relay_state\":" + String(relayState) + ",";
  json += "\"auto_mode\":" + String(autoModeEnabled);
  json += "}";

  server.send(200, "application/json", json);
}

// ------------------- SETUP -------------------
void setup() {
  Serial.begin(115200);
  delay(500);

  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, RELAY_ACTIVE_LOW ? HIGH : LOW);

  dht.begin();
  analogReadResolution(12);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(300);
    Serial.print(".");
  }

  Serial.println("\nConnected!");
  Serial.print("ESP32 IP: ");
  Serial.println(WiFi.localIP());

  server.on("/sensor", handleSensorAPI);
  server.begin();
}

// ------------------- LOOP -------------------
void loop() {
  server.handleClient();

  unsigned long now = millis();

  if (now - lastSensorRead >= SENSOR_INTERVAL) {
    lastSensorRead = now;
    readSensors();
  }

  handleRelayAuto();
}
